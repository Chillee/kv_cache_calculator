<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KV Cache Size Calculator</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .formula-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .formula-section h2 {
            margin-bottom: 15px;
            color: #34495e;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        
        input[type="number"], input[type="range"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .range-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-display input[type="range"] {
            flex: 1;
        }
        
        .range-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #3498db;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.secondary {
            background-color: #95a5a6;
        }
        
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .plot {
            width: 100%;
            height: 500px;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        
        .formula {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 15px 0;
        }
        
        .formula-text {
            font-size: 12px;
            display: inline-block;
            margin: 0 2px;
        }
        
        .param-sliding { color: #e74c3c; font-weight: 600; }
        .param-full { color: #3498db; font-weight: 600; }
        .param-value { color: #27ae60; font-weight: 600; }
        .param-dim { color: #9b59b6; font-weight: 600; }
        .param-mqa { color: #f39c12; font-weight: 600; }
        
        .layer-config {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .layer-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
        }
        
        .layer-info h4 {
            margin-bottom: 10px;
        }
        
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .config-item button {
            padding: 5px 15px;
            font-size: 12px;
        }
        
        .delete-btn {
            background-color: #e74c3c;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>KV Cache Size Calculator</h1>
        
        <div class="controls">
            <div style="margin-bottom: 20px;">
                <label for="presetModel" style="font-weight: 600; margin-right: 10px;">Load Preset Model:</label>
                <select id="presetModel" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">-- Select a preset --</option>
                    <option value="llama3-8b">Llama 3 8B</option>
                    <option value="llama3-70b">Llama 3 70B</option>
                    <option value="llama3-405b">Llama 3 405B</option>
                    <option value="deepseekv3">DeepSeek-V3 (671B)</option>
                    <option value="mixtral-8x7b">Mixtral 8x7B</option>
                    <option value="phi3-mini">Phi-3 Mini (3.8B)</option>
                    <option value="qwen2-7b">Qwen2 7B</option>
                    <option value="qwen2-72b">Qwen2 72B</option>
                </select>
            </div>
            <div class="control-grid">
                <div class="control-group">
                    <label for="numLayers">Total Number of Layers</label>
                    <input type="number" id="numLayers" value="32" step="1" min="1">
                </div>
                <div class="control-group">
                    <label for="headDim">Head Dimension</label>
                    <input type="number" id="headDim" value="128" step="1" min="1">
                </div>
                <div class="control-group">
                    <label for="numQueryHeads">Number of Query Heads</label>
                    <input type="number" id="numQueryHeads" value="32" step="1" min="1">
                </div>
                <div class="control-group">
                    <label for="slidingWindowSize">Sliding Window Size (tokens)</label>
                    <input type="number" id="slidingWindowSize" value="512" step="128" min="128">
                </div>
                <div class="control-group">
                    <label for="precision">Precision (bytes per value)</label>
                    <select id="precision">
                        <option value="2">FP16 (2 bytes)</option>
                        <option value="1">INT8 (1 byte)</option>
                        <option value="4">FP32 (4 bytes)</option>
                    </select>
                </div>
            </div>
            
            <div class="control-grid">
                <div class="control-group">
                    <label for="slidingWindowLayers">Number of Sliding Window Layers</label>
                    <input type="number" id="slidingWindowLayers" value="24" min="0" max="32" step="1">
                </div>
                <div class="control-group">
                    <label for="fullCausalLayers">Number of Full Causal Layers</label>
                    <input type="number" id="fullCausalLayers" value="8" readonly style="background: #ecf0f1;">
                </div>
            </div>
            
            <div class="control-grid">
                <div class="control-group">
                    <label for="mqaRateSlidingWindow">MQA Rate for Sliding Window Layers</label>
                    <select id="mqaRateSlidingWindow">
                        <!-- Options will be dynamically populated -->
                    </select>
                    <small style="color: #7f8c8d;">Higher = more compression (e.g., 8 means 8 query heads per KV head)</small>
                </div>
                <div class="control-group">
                    <label for="mqaRateFullCausal">MQA Rate for Full Causal Layers</label>
                    <select id="mqaRateFullCausal">
                        <!-- Options will be dynamically populated -->
                    </select>
                    <small style="color: #7f8c8d;">Higher = more compression</small>
                </div>
            </div>
            
            <div class="control-grid" style="margin-top: 20px;">
                <div class="control-group">
                    <label for="configName">Configuration Name (optional)</label>
                    <input type="text" id="configName" placeholder="e.g. Llama 3 8B Custom" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button onclick="addConfiguration()">Add Configuration</button>
                <button onclick="clearConfigurations()" class="secondary">Clear All</button>
                <button onclick="exportData()" class="secondary">Export to CSV</button>
            </div>
        </div>
        
        <div class="chart-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">KV Cache Size vs Sequence Length</h3>
                <div>
                    <label style="margin-right: 10px;">
                        <input type="checkbox" id="logScale" checked onchange="updateChart()">
                        Log Scale
                    </label>
                </div>
            </div>
            <div id="kvCacheChart" class="plot"></div>
        </div>
        
        <div class="controls" id="configList" style="display: none;">
            <h3>Active Configurations</h3>
            <div id="configListItems" style="margin-top: 15px;"></div>
        </div>
        
        <div class="formula-section">
            <h2>KV Cache Calculation Formula</h2>
            <div class="formula">
                <div id="formula-display">
                    <!-- Formula will be dynamically generated here -->
                </div>
            </div>
        </div>
        
    </div>
    
    <script>
        // Configure MathJax
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
        
        // Store multiple configurations
        let configurations = [];
        let configCounter = 0;
        
        // Model presets
        const modelPresets = {
            'llama3-8b': {
                numLayers: 32,
                headDim: 128,
                numQueryHeads: 32,
                slidingWindowLayers: 0,
                slidingWindowSize: 512,
                mqaRateSlidingWindow: 1,
                mqaRateFullCausal: 8
            },
            'llama3-70b': {
                numLayers: 80,
                headDim: 128,
                numQueryHeads: 64,
                slidingWindowLayers: 0,
                slidingWindowSize: 512,
                mqaRateSlidingWindow: 1,
                mqaRateFullCausal: 8
            },
            'llama3-405b': {
                numLayers: 126,
                headDim: 128,
                numQueryHeads: 128,
                slidingWindowLayers: 0,
                slidingWindowSize: 512,
                mqaRateSlidingWindow: 1,
                mqaRateFullCausal: 8
            },
            'deepseekv3': {
                numLayers: 61,
                headDim: 128,
                numQueryHeads: 128,
                slidingWindowLayers: 0,
                slidingWindowSize: 512,
                mqaRateSlidingWindow: 1,
                mqaRateFullCausal: 16  // MLA compression equivalent to 16:1 MQA
            },
            'mixtral-8x7b': {
                numLayers: 32,
                headDim: 128,
                numQueryHeads: 32,
                slidingWindowLayers: 32,
                slidingWindowSize: 32768,
                mqaRateSlidingWindow: 8,
                mqaRateFullCausal: 1
            },
            'phi3-mini': {
                numLayers: 32,
                headDim: 96,
                numQueryHeads: 32,
                slidingWindowLayers: 0,
                slidingWindowSize: 512,
                mqaRateSlidingWindow: 1,
                mqaRateFullCausal: 1
            },
            'qwen2-7b': {
                numLayers: 32,
                headDim: 128,
                numQueryHeads: 32,
                slidingWindowLayers: 0,
                slidingWindowSize: 512,
                mqaRateSlidingWindow: 1,
                mqaRateFullCausal: 1
            },
            'qwen2-72b': {
                numLayers: 80,
                headDim: 128,
                numQueryHeads: 64,
                slidingWindowLayers: 0,
                slidingWindowSize: 512,
                mqaRateSlidingWindow: 1,
                mqaRateFullCausal: 8
            }
        };
        
        // Update full causal layers when sliding window layers change
        document.getElementById('slidingWindowLayers').addEventListener('input', function(e) {
            const totalLayers = parseInt(document.getElementById('numLayers').value);
            const slidingLayers = parseInt(e.target.value);
            const fullLayers = totalLayers - slidingLayers;
            
            document.getElementById('fullCausalLayers').value = fullLayers;
        });
        
        // Update MQA dropdowns
        document.getElementById('mqaRateSlidingWindow').addEventListener('change', function(e) {
        });
        
        document.getElementById('mqaRateFullCausal').addEventListener('change', function(e) {
        });
        
        // Function to get divisors of a number
        function getDivisors(n) {
            const divisors = [];
            for (let i = 1; i <= n; i++) {
                if (n % i === 0) {
                    divisors.push(i);
                }
            }
            return divisors;
        }
        
        // Function to update MQA dropdown options
        function updateMQADropdowns() {
            const numQueryHeads = parseInt(document.getElementById('numQueryHeads').value);
            const divisors = getDivisors(numQueryHeads);
            
            // Save current selections
            const currentSlidingMQA = document.getElementById('mqaRateSlidingWindow').value;
            const currentFullMQA = document.getElementById('mqaRateFullCausal').value;
            
            // Update sliding window MQA dropdown
            const slidingSelect = document.getElementById('mqaRateSlidingWindow');
            slidingSelect.innerHTML = '';
            divisors.forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = `${d}:1 (${numQueryHeads/d} KV heads)`;
                slidingSelect.appendChild(option);
            });
            
            // Update full causal MQA dropdown
            const fullSelect = document.getElementById('mqaRateFullCausal');
            fullSelect.innerHTML = '';
            divisors.forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = `${d}:1 (${numQueryHeads/d} KV heads)`;
                fullSelect.appendChild(option);
            });
            
            // Restore selections if still valid, otherwise select sensible defaults
            if (divisors.includes(parseInt(currentSlidingMQA))) {
                slidingSelect.value = currentSlidingMQA;
            } else {
                // Default to 1:1 (no compression)
                slidingSelect.value = '1';
            }
            
            if (divisors.includes(parseInt(currentFullMQA))) {
                fullSelect.value = currentFullMQA;
            } else {
                // Default to 4:1 if available, otherwise a lower compression ratio
                fullSelect.value = divisors.includes(4) ? '4' : divisors[Math.min(2, divisors.length-1)];
            }
        }
        
        // Update total layers
        document.getElementById('numLayers').addEventListener('input', function(e) {
            const totalLayers = parseInt(e.target.value);
            const slidingLayers = parseInt(document.getElementById('slidingWindowLayers').value);
            
            // Adjust max and current value if needed
            document.getElementById('slidingWindowLayers').max = totalLayers;
            if (slidingLayers > totalLayers) {
                document.getElementById('slidingWindowLayers').value = totalLayers;
            }
            
            document.getElementById('fullCausalLayers').value = totalLayers - slidingLayers;
        });
        
        // Add event listeners for updates
        document.getElementById('headDim').addEventListener('input', function() {
        });
        document.getElementById('numQueryHeads').addEventListener('input', function() {
            updateMQADropdowns();
        });
        
        // Preset model dropdown handler
        document.getElementById('presetModel').addEventListener('change', function(e) {
            const presetName = e.target.value;
            if (presetName && modelPresets[presetName]) {
                const preset = modelPresets[presetName];
                document.getElementById('numLayers').value = preset.numLayers;
                document.getElementById('headDim').value = preset.headDim;
                document.getElementById('numQueryHeads').value = preset.numQueryHeads;
                document.getElementById('slidingWindowLayers').value = preset.slidingWindowLayers;
                document.getElementById('fullCausalLayers').value = preset.numLayers - preset.slidingWindowLayers;
                document.getElementById('slidingWindowSize').value = preset.slidingWindowSize;
                
                // Set configuration name to the preset name
                const displayName = document.getElementById('presetModel').options[document.getElementById('presetModel').selectedIndex].text;
                document.getElementById('configName').value = displayName;
                
                // Update MQA dropdowns and set values
                updateMQADropdowns();
                setTimeout(() => {
                    document.getElementById('mqaRateSlidingWindow').value = preset.mqaRateSlidingWindow;
                    document.getElementById('mqaRateFullCausal').value = preset.mqaRateFullCausal;
                    updateFormula();
                }, 50);
            }
        });
        
        function calculateKVCacheSize(sequenceLength, params) {
            const bytesPerValue = parseFloat(document.getElementById('precision').value);
            const modelDim = params.headDim * params.numQueryHeads;
            
            // Sliding window layers KV cache
            const effectiveSeqLengthSliding = Math.min(sequenceLength, params.slidingWindowSize);
            const kvDimSliding = modelDim / params.mqaRateSlidingWindow;
            const slidingWindowCache = params.slidingWindowLayers * 2 * effectiveSeqLengthSliding * kvDimSliding * bytesPerValue;
            
            // Full causal layers KV cache
            const kvDimFull = modelDim / params.mqaRateFullCausal;
            const fullCausalCache = params.fullCausalLayers * 2 * sequenceLength * kvDimFull * bytesPerValue;
            
            // Total in GB
            const totalCacheBytes = slidingWindowCache + fullCausalCache;
            const totalCacheGB = totalCacheBytes / (1024 * 1024 * 1024);
            
            return {
                total: totalCacheGB,
                slidingWindow: slidingWindowCache / (1024 * 1024 * 1024),
                fullCausal: fullCausalCache / (1024 * 1024 * 1024),
                slidingWindowBytes: slidingWindowCache,
                fullCausalBytes: fullCausalCache
            };
        }
        
        
        
        function getParams() {
            return {
                numLayers: parseInt(document.getElementById('numLayers').value),
                headDim: parseInt(document.getElementById('headDim').value),
                numQueryHeads: parseInt(document.getElementById('numQueryHeads').value),
                slidingWindowLayers: parseInt(document.getElementById('slidingWindowLayers').value),
                fullCausalLayers: parseInt(document.getElementById('fullCausalLayers').value),
                slidingWindowSize: parseInt(document.getElementById('slidingWindowSize').value),
                mqaRateSlidingWindow: parseInt(document.getElementById('mqaRateSlidingWindow').value),
                mqaRateFullCausal: parseInt(document.getElementById('mqaRateFullCausal').value)
            };
        }
        
        function addConfiguration() {
            const params = getParams();
            const modelDim = params.headDim * params.numQueryHeads;
            
            // Get custom name or create default label
            const customName = document.getElementById('configName').value.trim();
            let configLabel;
            
            if (customName) {
                configLabel = customName;
            } else {
                // Create configuration label
                const kvHeadsSW = Math.floor(params.numQueryHeads / params.mqaRateSlidingWindow);
                const kvHeadsFC = Math.floor(params.numQueryHeads / params.mqaRateFullCausal);
                configLabel = `Config ${configCounter + 1}: ${params.numLayers}L, SW:${params.slidingWindowLayers}L${kvHeadsSW}H, FC:${params.fullCausalLayers}L${kvHeadsFC}H`;
            }
            
            // Clear the name input for next configuration
            document.getElementById('configName').value = '';
            
            // Generate data for this configuration
            const sequenceLengths = [];
            const totalCache = [];
            
            for (let i = 7; i <= 17; i += 0.1) {
                const seqLen = Math.round(Math.pow(2, i));
                const cache = calculateKVCacheSize(seqLen, params);
                
                sequenceLengths.push(seqLen);
                totalCache.push(cache.total);
            }
            
            // Store configuration
            configurations.push({
                id: configCounter++,
                label: configLabel,
                customName: customName,
                params: {...params},
                sequenceLengths: sequenceLengths,
                totalCache: totalCache
            });
            
            updateChart();
            updateConfigList();
            updateURL();
        }
        
        function clearConfigurations() {
            configurations = [];
            configCounter = 0;
            updateChart();
            updateConfigList();
            updateURL();
        }
        
        function updateURL() {
            const configData = configurations.map(c => ({
                nl: c.params.numLayers,
                hd: c.params.headDim,
                nq: c.params.numQueryHeads,
                swl: c.params.slidingWindowLayers,
                sws: c.params.slidingWindowSize,
                swm: c.params.mqaRateSlidingWindow,
                fcm: c.params.mqaRateFullCausal,
                name: c.customName || ''
            }));
            
            const params = new URLSearchParams();
            if (configData.length > 0) {
                params.set('configs', JSON.stringify(configData));
            }
            
            const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.replaceState({}, '', newURL);
        }
        
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const configsParam = params.get('configs');
            
            if (configsParam) {
                try {
                    const configs = JSON.parse(configsParam);
                    configs.forEach(c => {
                        // Set parameters
                        document.getElementById('numLayers').value = c.nl;
                        document.getElementById('headDim').value = c.hd;
                        document.getElementById('numQueryHeads').value = c.nq;
                        document.getElementById('slidingWindowLayers').value = c.swl;
                        document.getElementById('fullCausalLayers').value = c.nl - c.swl;
                        document.getElementById('slidingWindowSize').value = c.sws;
                        
                        // Set custom name if available
                        if (c.name) {
                            document.getElementById('configName').value = c.name;
                        }
                        
                        // Update MQA dropdowns
                        updateMQADropdowns();
                        
                        // Set MQA values after a short delay
                        setTimeout(() => {
                            document.getElementById('mqaRateSlidingWindow').value = c.swm;
                            document.getElementById('mqaRateFullCausal').value = c.fcm;
                            
                            // Add the configuration
                            addConfiguration();
                        }, 50);
                    });
                } catch (e) {
                    console.error('Failed to load configurations from URL:', e);
                }
            }
        }
        
        function deleteConfiguration(id) {
            configurations = configurations.filter(config => config.id !== id);
            updateChart();
            updateConfigList();
            updateURL();
        }
        
        function updateConfigList() {
            const configListDiv = document.getElementById('configList');
            const configListItems = document.getElementById('configListItems');
            
            if (configurations.length === 0) {
                configListDiv.style.display = 'none';
                return;
            }
            
            configListDiv.style.display = 'block';
            configListItems.innerHTML = '';
            
            configurations.forEach(config => {
                const item = document.createElement('div');
                item.className = 'config-item';
                item.innerHTML = `
                    <span>${config.label}</span>
                    <button onclick="deleteConfiguration(${config.id})" class="delete-btn">Delete</button>
                `;
                configListItems.appendChild(item);
            });
        }
        
        function updateChart() {
            // Create traces for all configurations
            const traces = configurations.map((config, index) => ({
                x: config.sequenceLengths,
                y: config.totalCache,
                mode: 'lines',
                name: config.label,
                line: { width: 3 }
            }));
            
            const isLogScale = document.getElementById('logScale').checked;
            
            const layout = {
                xaxis: {
                    title: 'Sequence Length (tokens)',
                    type: isLogScale ? 'log' : 'linear',
                    tickformat: '.0f'
                },
                yaxis: {
                    title: 'KV Cache Size (GB)',
                    type: isLogScale ? 'log' : 'linear'
                },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('kvCacheChart', traces, layout);
            
            // Update formula with current parameters
            updateFormula();
        }
        
        function updateFormula() {
            const params = getParams();
            const bytesPerValue = parseFloat(document.getElementById('precision').value);
            const precisionName = document.getElementById('precision').options[document.getElementById('precision').selectedIndex].text;
            const modelDim = params.headDim * params.numQueryHeads;
            
            const formulaHTML = `
                $$\\text{Total KV Cache} = \\text{Sliding Window Cache} + \\text{Full Causal Cache}$$
                <div style="text-align: center; margin-top: -10px;">
                    <span class="formula-text">Total KV Cache = </span>
                    <span class="formula-text param-sliding">Sliding Window Layers Cache</span>
                    <span class="formula-text"> + </span>
                    <span class="formula-text param-full">Full Causal Layers Cache</span>
                </div>
                
                <br><br>
                $$\\text{Sliding Window Cache} = L_{sw} \\times 2 \\times \\min(S, W) \\times \\frac{d_{head} \\times n_{heads}}{MQA_{sw}} \\times B$$
                <div style="text-align: center; margin-top: -10px;">
                    <span class="formula-text param-sliding">Sliding Window Cache</span> = 
                    <span class="formula-text param-value">${params.slidingWindowLayers}</span> × 2 × min(Seq, 
                    <span class="formula-text param-value">${params.slidingWindowSize}</span>) × 
                    <span class="formula-text param-dim">${params.headDim} × ${params.numQueryHeads}</span>/
                    <span class="formula-text param-mqa">${params.mqaRateSlidingWindow}</span> × 
                    <span class="formula-text param-value">${bytesPerValue}</span> bytes
                </div>
                
                <br><br>
                $$\\text{Full Causal Cache} = L_{fc} \\times 2 \\times S \\times \\frac{d_{head} \\times n_{heads}}{MQA_{fc}} \\times B$$
                <div style="text-align: center; margin-top: -10px;">
                    <span class="formula-text param-full">Full Causal Cache</span> = 
                    <span class="formula-text param-value">${params.fullCausalLayers}</span> × 2 × Seq × 
                    <span class="formula-text param-dim">${params.headDim} × ${params.numQueryHeads}</span>/
                    <span class="formula-text param-mqa">${params.mqaRateFullCausal}</span> × 
                    <span class="formula-text param-value">${bytesPerValue}</span> bytes
                </div>
                
                <br><div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 20px;">
                <strong>Legend:</strong><br><br>
                • <span class="param-value">L<sub>sw</sub></span> = Number of sliding window layers (${params.slidingWindowLayers})<br>
                • <span class="param-value">L<sub>fc</sub></span> = Number of full causal layers (${params.fullCausalLayers})<br>
                • <span class="param-value">S</span> = Sequence length (variable)<br>
                • <span class="param-value">W</span> = Sliding window size (${params.slidingWindowSize})<br>
                • <span class="param-dim">d<sub>head</sub></span> = Head dimension (${params.headDim})<br>
                • <span class="param-dim">n<sub>heads</sub></span> = Number of query heads (${params.numQueryHeads})<br>
                • <span class="param-dim">d<sub>model</sub></span> = d<sub>head</sub> × n<sub>heads</sub> = ${modelDim}<br>
                • <span class="param-mqa">MQA<sub>sw</sub></span> = MQA rate for sliding window (${params.mqaRateSlidingWindow}:1 compression)<br>
                • <span class="param-mqa">MQA<sub>fc</sub></span> = MQA rate for full causal (${params.mqaRateFullCausal}:1 compression)<br>
                • <span class="param-value">B</span> = Bytes per value (${precisionName})<br>
                • Factor of 2 = K and V caches
                </div>
            `;
            
            document.getElementById('formula-display').innerHTML = formulaHTML;
            
            // Re-render MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([document.getElementById('formula-display')]).catch((e) => console.error(e));
            }
        }
        
        function exportData() {
            if (configurations.length === 0) {
                alert('No configurations to export. Please add at least one configuration.');
                return;
            }
            
            // Create CSV header
            let csv = 'Sequence Length';
            configurations.forEach(config => {
                csv += `,${config.label}`;
            });
            csv += '\n';
            
            // Add data rows
            const seqLengths = configurations[0].sequenceLengths;
            for (let i = 0; i < seqLengths.length; i += 10) { // Export every 10th point
                csv += seqLengths[i];
                configurations.forEach(config => {
                    csv += `,${config.totalCache[i].toFixed(4)}`;
                });
                csv += '\n';
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kv_cache_comparison.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Initialize on load
        window.onload = function() {
            updateMQADropdowns();
            updateFormula();
            
            // Load configurations from URL if present
            setTimeout(() => {
                loadFromURL();
            }, 100);
        };
    </script>
</body>
</html>